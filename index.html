<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scary Search Loading</title>
    <style>
        :root {
            --accent: #e74c3c;
            --accent-glow: rgba(231, 76, 60, 0.5);
            --secondary: #f39c12; 
        }

        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
            cursor: none;
        }

        #bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(20,20,20,1) 0%, rgba(0,0,0,1) 100%);
            z-index: -1;
        }

        #visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            z-index: 0;
            opacity: 0.8;
            pointer-events: none;
        }

        #content {
            width: 80%;
            max-width: 800px;
            text-align: center;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Уменьшил отступ, так как текста между полосками нет */
        }

        h1 {
            font-size: 3.5em;
            font-weight: 900;
            margin: 0 0 10px 0;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 5px;
            text-shadow: 0 0 20px var(--accent-glow);
            transition: transform 0.05s ease-out;
        }

        #main-status {
            font-size: 1.5em; /* Чуть уменьшил, чтобы длинные пути влезали */
            font-weight: 400;
            color: #ecf0f1;
            margin: 0 0 10px 0;
            opacity: 1;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            min-height: 1.2em;
            
            /* Если путь очень длинный, обрезаем его красиво */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .progress-container {
            width: 100%;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- ПЕРВАЯ ПОЛОСКА (Общий прогресс) --- */
        #progress-bg-main {
            height: 12px; /* Чуть толще */
        }
        #progress-bar-main {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.2s linear;
            box-shadow: 0 0 10px var(--accent);
        }

        /* --- ВТОРАЯ ПОЛОСКА (Активность файла) --- */
        #progress-bg-file {
            height: 6px; /* Тонкая полоска снизу */
            margin-top: -5px; /* Ближе к верхней */
            opacity: 0; /* Скрыта, пока не начнем качать */
            transition: opacity 0.3s;
        }
        
        #progress-bar-file {
            height: 100%;
            width: 100%;
            background-color: var(--secondary);
            
            /* Эффект "Зебры" */
            background-image: linear-gradient(
                45deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.2) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 20px 20px;
            box-shadow: 0 0 5px var(--secondary);
            animation: move-stripes 1s linear infinite;
        }

        @keyframes move-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        #debug-log {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-family: monospace;
            color: #333;
            font-size: 10px;
            text-align: right;
            pointer-events: none;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="bg"></div>
    <canvas id="visualizer"></canvas>
    <div id="debug-log">System Boot...</div>

    <div id="content">
        <h1 id="server-name">SCARY SEARCH</h1>
        
        <h2 id="main-status">Connecting...</h2>
        
        <div class="progress-container" id="progress-bg-main">
            <div id="progress-bar-main"></div>
        </div>

        <div class="progress-container" id="progress-bg-file">
            <div id="progress-bar-file"></div>
        </div>
    </div>

    <audio id="bg-music" src="loading_music.mp3" loop preload="auto"></audio>

    <script>
        const MUSIC_FILE = 'loading_music.mp3';
        const BAR_COUNT = 64;
        const FPS = 60;
        const SENSITIVITY = 1.5;
        
        const elServer = document.getElementById('server-name');
        const elMainStatus = document.getElementById('main-status');
        
        const elBarMain = document.getElementById('progress-bar-main');
        // Сам контейнер второй полоски (чтобы скрывать/показывать целиком)
        const elBgFile = document.getElementById('progress-bg-file'); 
        
        const cvs = document.getElementById('visualizer');
        const ctx = cvs.getContext('2d');
        const audio = document.getElementById('bg-music');
        const debugLog = document.getElementById('debug-log');
        const root = document.documentElement;

        let audioData = null;
        let isAnalyzed = false;
        
        let filesTotal = 0;
        let filesNeeded = 0;
        let colorHue = 0;

        function log(msg) {
            debugLog.innerHTML += "<br>" + msg;
        }

        function resize() {
            cvs.width = window.innerWidth;
            cvs.height = window.innerHeight * 0.4;
        }
        window.addEventListener('resize', resize);
        resize();

        async function analyzeAudio(url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const tempCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await tempCtx.decodeAudioData(arrayBuffer);
                processAudioBuffer(audioBuffer);
            } catch (e) {
                log("Simulating Visualizer");
            }
        }

        function processAudioBuffer(buffer) {
            const rawData = buffer.getChannelData(0);
            const samplesPerFrame = Math.floor(buffer.sampleRate / FPS);
            const totalFrames = Math.floor(rawData.length / samplesPerFrame);
            audioData = new Float32Array(totalFrames);
            for (let i = 0; i < totalFrames; i++) {
                const start = i * samplesPerFrame;
                let sum = 0;
                for (let j = 0; j < samplesPerFrame; j++) {
                    sum += rawData[start + j] * rawData[start + j];
                }
                audioData[i] = Math.sqrt(sum / samplesPerFrame);
            }
            isAnalyzed = true;
        }

        function tryPlayMusic() {
            if (!audio.paused) return;
            audio.volume = 0.3;
            audio.play().catch(e => {});
        }

        window.addEventListener('load', () => {
            analyzeAudio(MUSIC_FILE);
            tryPlayMusic();
            animate();
        });
        document.addEventListener('click', tryPlayMusic);
        document.addEventListener('keydown', tryPlayMusic);

        function animate() {
            requestAnimationFrame(animate);
            const time = audio.currentTime;
            let currentVolume = 0;

            if (isAnalyzed && audioData) {
                const frameIndex = Math.floor(time * FPS);
                if (frameIndex < audioData.length) {
                    currentVolume = audioData[frameIndex] * SENSITIVITY;
                }
            } else if (!audio.paused) {
                currentVolume = (Math.sin(time * 5) * 0.5 + 0.5) * 0.2;
            }
            currentVolume = Math.max(0, currentVolume);

            colorHue = (colorHue + 0.5 + currentVolume * 2) % 360;
            const mainColor = `hsl(${colorHue}, 80%, 60%)`;
            const glowColor = `hsla(${colorHue}, 80%, 60%, 0.5)`;
            root.style.setProperty('--accent', mainColor);
            root.style.setProperty('--accent-glow', glowColor);

            const scale = 1 + (currentVolume * 0.1);
            elServer.style.transform = `scale(${scale})`;

            ctx.clearRect(0, 0, cvs.width, cvs.height);
            const barWidth = cvs.width / BAR_COUNT;
            for (let i = 0; i < BAR_COUNT; i++) {
                const centerOffset = Math.abs(i - BAR_COUNT / 2) / (BAR_COUNT / 2);
                const wave = Math.sin(i * 0.2 + time * 3) * 0.5 + 0.5;
                const wave2 = Math.cos(i * 0.3 - time * 2) * 0.3;
                let barHeight = (wave + wave2) * cvs.height * 0.5 * (currentVolume + 0.1);
                barHeight *= (1.2 - centerOffset);
                barHeight += currentVolume * cvs.height * 0.3 * (1 - centerOffset);
                ctx.fillStyle = `hsla(${colorHue}, 80%, 60%, ${Math.min(1, currentVolume + 0.3)})`;
                ctx.fillRect(i * barWidth, cvs.height - barHeight, barWidth - 2, barHeight);
            }
        }

        // === LOGIC GMOD ===

        function GameDetails(servername, serverurl, mapname, maxplayers, steamid, gamemode) {
            elServer.innerText = servername;
        }

        function SetStatusChanged(status) {
            elMainStatus.innerText = status;
            
            // Если статус не о скачивании, скрываем нижнюю полоску
            if(status.indexOf("Getting Addon Info") !== -1 || status === "Sending Client Info" || status === "Mounting Addons") {
                 elBgFile.style.opacity = "0";
            }
        }

        function DownloadingFile(fileName) {
            // Пишем имя файла в ГЛАВНЫЙ статус
            elMainStatus.innerText = "Downloading: " + fileName;
            
            // Показываем нижнюю полоску активности
            elBgFile.style.opacity = "1";
        }

        function SetFilesTotal(total) {
            filesTotal = total;
        }

        function SetFilesNeeded(needed) {
            filesNeeded = needed;
            if (filesTotal > 0) {
                const downloaded = filesTotal - filesNeeded;
                const percent = (downloaded / filesTotal) * 100;
                elBarMain.style.width = Math.min(percent, 100) + '%';
            }
        }
        
        // Тест для браузера
        if (!window.gmod && !window.gtps) {
           setTimeout(() => { 
               SetStatusChanged("Preparing Assets...");
               SetFilesTotal(5);
               let needed = 5;
               
               const interval = setInterval(() => {
                   if(needed > 0) {
                       needed--;
                       SetFilesNeeded(needed);
                       // Эмуляция длинного пути к файлу
                       DownloadingFile("models/scary_search/monsters/very_scary_model_" + needed + ".mdl");
                   } else {
                       clearInterval(interval);
                       SetStatusChanged("Sending Client Info...");
                   }
               }, 3000);
           }, 1000);
        }
    </script>
</body>
</html>